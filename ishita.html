<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>For My Ishita ❤️</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient-start: #ff8a80; /* Soft Coral Pink */
            --primary-gradient-end: #ffcdb2;   /* Melon */
            --primary-color: #ff8a80;
            --accent-color: #e57373;   /* Lighter Coral */
            --background-light: #fff5f5; /* Very Light Pink */
            --background-card: #ffffff;
            --text-dark: #5d4037;    /* Deep Brown */
            --text-medium: #8d6e63; /* Lighter Brown */
            --border-light: #ffcdd2; /* Light Pink Border */
            --shadow-light: rgba(0, 0, 0, 0.05);
            --shadow-medium: rgba(0, 0, 0, 0.1);
            --shadow-strong: rgba(188, 124, 124, 0.2);
            --success-color: #81c784; /* Soft Green */
            --error-color: #e57373; /* Lighter Coral */

            /* RGB values for dynamic shadows */
            --primary-color-rgb: 255, 138, 128;
            --error-color-rgb: 229, 115, 115;
            --success-color-rgb: 129, 199, 132;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--primary-gradient-start) 0%, var(--primary-gradient-end) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--text-dark);
            overflow: hidden; 
        }

        .chat-container {
            background: var(--background-card);
            border-radius: 28px;
            box-shadow: 0 20px 50px var(--shadow-strong);
            width: 100%;
            max-width: 900px; 
            height: 700px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            transform: scale(0.98);
            animation: containerLoad 0.6s ease-out forwards;
        }

        @keyframes containerLoad {
            from { opacity: 0; transform: scale(0.95) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .header {
            background: linear-gradient(135deg, var(--primary-gradient-start) 0%, var(--primary-gradient-end) 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            box-shadow: 0 4px 15px var(--shadow-medium);
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }

        .header h1 {
            font-family: 'Dancing Script', cursive;
            font-size: 42px; /* Larger romantic title */
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.95;
            font-weight: 300;
        }

        .settings-toggle {
            position: absolute;
            top: 25px;
            right: 25px;
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            padding: 12px 18px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .settings-toggle:hover {
            background: rgba(255, 255, 255, 0.45);
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .mode-toggle {
            position: absolute;
            top: 25px;
            left: 25px;
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            padding: 12px 18px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .mode-toggle:hover {
            background: rgba(255, 255, 255, 0.45);
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .settings-panel {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--background-card);
            z-index: 1000;
            padding: 35px;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 0 40px var(--shadow-strong);
        }

        .settings-panel.active {
            transform: translateX(0);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-light);
        }

        .settings-header h2 {
            color: var(--text-dark);
            font-size: 26px;
            font-weight: 600;
        }

        .close-settings {
            background: var(--error-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .close-settings:hover {
            background: #e63946;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .messages {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: var(--background-light);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .messages::-webkit-scrollbar { width: 8px; }
        .messages::-webkit-scrollbar-track { background: var(--border-light); border-radius: 10px; }
        .messages::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 10px; }
        .messages::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }

        .message {
            display: flex;
            align-items: flex-start;
            animation: fadeIn 0.5s ease-out forwards;
            max-width: 85%;
            transform: translateX(0);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            justify-content: flex-end;
            margin-left: auto;
        }

        .message-content {
            padding: 16px 22px;
            border-radius: 25px;
            font-size: 16px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
            box-shadow: 0 5px 15px var(--shadow-light);
            transition: transform 0.2s ease;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--primary-gradient-start) 0%, var(--primary-gradient-end) 100%);
            color: white;
            border-bottom-right-radius: 10px;
        }

        .message.assistant .message-content {
            background: var(--background-card);
            color: var(--text-dark);
            border: 1px solid var(--border-light);
            border-bottom-left-radius: 10px;
        }

        .chat-container.speech-mode .message.assistant {
            display: none;
        }

        .input-container {
            padding: 25px 30px;
            background: var(--background-card);
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: 15px;
            align-items: center;
            box-shadow: 0 -5px 15px var(--shadow-light);
        }

        .message-input {
            flex: 1;
            padding: 16px 22px;
            border: 1px solid var(--border-light);
            border-radius: 35px;
            font-size: 17px;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background-color: var(--background-light);
            box-shadow: inset 0 1px 3px var(--shadow-light);
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(var(--primary-color-rgb), 0.25), inset 0 1px 3px var(--shadow-medium);
        }

        .send-button {
            background: linear-gradient(135deg, var(--primary-gradient-start) 0%, var(--primary-gradient-end) 100%);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 35px;
            cursor: pointer;
            font-size: 17px;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 6px 20px rgba(var(--primary-color-rgb), 0.35);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(var(--primary-color-rgb), 0.5);
        }

        .mic-button {
            background: var(--background-light);
            color: var(--text-dark);
            border: 1px solid var(--border-light);
            border-radius: 50%;
            padding: 16px;
            cursor: pointer;
            font-size: 22px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 58px;
            height: 58px;
            box-shadow: 0 3px 8px var(--shadow-light);
        }

        .mic-button:hover {
            background: #fff0f0;
            color: var(--primary-color);
            border-color: var(--primary-color);
            box-shadow: 0 5px 12px var(--shadow-medium);
        }
        
        .mic-button.recording {
            background: var(--error-color);
            color: white;
            border-color: var(--error-color);
            animation: pulse 1.2s infinite cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(var(--error-color-rgb), 0.6); }
            50% { transform: scale(1.1); box-shadow: 0 0 0 15px rgba(var(--error-color-rgb), 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(var(--error-color-rgb), 0); }
        }

        .voice-dialog {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(93, 64, 55, 0.7); /* Deep Brown Overlay */
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }

        .voice-dialog-content {
            background: var(--background-card);
            padding: 35px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 15px 40px var(--shadow-strong);
            position: relative;
            animation: slideInUp 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @keyframes slideInUp {
            from { transform: translateY(80px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .voice-dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-light);
            width: 100%;
        }

        .voice-dialog-header h3 {
            font-size: 24px;
            color: var(--text-dark);
            font-weight: 600;
            font-family: 'Dancing Script', cursive;
        }

        .close-dialog {
            background: none; border: none; font-size: 30px; cursor: pointer; color: var(--text-medium);
            transition: color 0.2s ease;
        }
        .close-dialog:hover { color: var(--error-color); }

        #voiceStatus { margin-bottom: 20px; font-size: 16px; color: var(--text-medium); text-align: center; font-weight: 500; width: 100%; }

        #transcription {
            min-height: 100px;
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 25px;
            background: var(--background-light);
            font-style: italic;
            color: var(--text-dark);
            font-size: 16px;
            line-height: 1.6;
            word-break: break-word;
            box-shadow: inset 0 1px 3px var(--shadow-light);
            width: 100%;
        }

        .voice-actions { display: flex; gap: 15px; justify-content: center; width: 100%; flex-wrap: wrap; }

        .voice-actions button {
            padding: 14px 22px; border: none; border-radius: 10px; cursor: pointer; font-size: 16px;
            font-weight: 600; transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1); flex-grow: 1; min-width: 120px;
        }

        .voice-actions button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }

        #startListening { background: var(--success-color); color: white; }
        #startListening:hover:enabled { background: #66bb6a; transform: translateY(-2px); box-shadow: 0 5px 10px rgba(var(--success-color-rgb), 0.3); }

        #stopListening { background: var(--error-color); color: white; }
        #stopListening:hover:enabled { background: #d32f2f; transform: translateY(-2px); box-shadow: 0 5px 10px rgba(var(--error-color-rgb), 0.3); }

        #sendVoiceMessage { background: var(--primary-color); color: white; }
        #sendVoiceMessage:hover:enabled { background: var(--accent-color); transform: translateY(-2px); box-shadow: 0 5px 10px rgba(var(--primary-color-rgb), 0.3); }

        .loading {
            display: none; text-align: center; padding: 18px; color: var(--text-medium);
            font-style: italic; font-size: 16px; background: var(--background-light);
            border-top: 1px solid var(--border-light); animation: pulseText 1.5s infinite ease-in-out;
        }

        @keyframes pulseText { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }
        .loading.active { display: block; }
        
        .text-mode .mic-button { display: none; }
        .text-mode .message-input, .text-mode .send-button { display: flex; }
        .speech-mode .message-input, .speech-mode .send-button { display: none; }
        .speech-mode .mic-button { display: flex; }

        .speech-mode #voiceDialog .loading-indicator {
            display: none; margin-top: 15px; font-size: 15px; color: var(--text-medium);
            font-style: italic; animation: pulseText 1.5s infinite ease-in-out;
        }
        .speech-mode #voiceDialog .loading-indicator.active { display: block; }

        #stopBotResponseButtonDialog {
            background: #f44336; color: white; border: none; padding: 12px 20px;
            border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: 600;
            margin-top: 20px; transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1); width: fit-content; align-self: center; display: none;
        }
        #stopBotResponseButtonDialog:hover { background: #d32f2f; transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2); }
        
        @media (max-width: 768px) {
            body { padding: 0; overflow-y: auto; }
            .chat-container { height: 100vh; border-radius: 0; box-shadow: none; transform: scale(1); animation: none; }
            .header { padding: 25px; }
            .header h1 { font-size: 32px; }
            .header p { font-size: 14px; }
            .settings-toggle, .mode-toggle { top: 20px; padding: 10px 15px; font-size: 14px; gap: 6px; }
            .settings-toggle { right: 20px; }
            .mode-toggle { left: 20px; }
            .settings-panel { padding: 25px; transition: transform 0.3s ease; }
            .messages { padding: 20px; gap: 15px; }
            .input-container { padding: 20px; flex-wrap: wrap; justify-content: center; }
            .message-input { width: 100%; }
            .send-button, .mic-button { flex-grow: 1; }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header">
            <h1 id="mainHeader">Happy Girlfriend's Day, Ishita! ❤️</h1>
            <p id="subHeader">A special bot, just for you, from Dhruv.</p>
            <button class="settings-toggle" id="settingsToggleBtn" onclick="toggleSettings()">✨ Our Special Place</button>
            <button class="mode-toggle" id="modeToggle" onclick="toggleMode()">💌 Send a Note</button>
        </div>

        <div class="settings-panel" id="settingsPanel">
            <div class="settings-header">
                <h2 id="settingsTitle">Our Special Place ✨</h2>
                <button class="close-settings" onclick="toggleSettings()" id="closeSettingsBtn">Close</button>
            </div>
            <p style="text-align: center; color: var(--text-medium); font-style: italic;">This is a little corner I made just for you, my love. Everything here is designed to remind you how much you mean to me. - Dhruv</p>
            </div>

        <div id="voiceDialog" class="voice-dialog">
            <div class="voice-dialog-content">
                <div class="voice-dialog-header">
                    <h3 id="voiceDialogTitle">Leave a Sweet Voice Note 💬</h3>
                    <button class="close-dialog" id="closeDialog">×</button>
                </div>
                <div id="voiceStatus">Click 'Start' to record your lovely voice...</div>
                <div id="transcription">Your sweet words will appear here...</div>
                <div class="voice-actions">
                    <button id="startListening">Start</button>
                    <button id="stopListening" disabled>Stop</button>
                    <button id="sendVoiceMessage" disabled>Send with Love</button>
                </div>
                <div class="loading-indicator" id="voiceLoadingIndicator">Thinking about how much Dhruv loves you...</div>
                <button id="stopBotResponseButtonDialog">Stop my words</button> 
            </div>
        </div>

        <div class="messages" id="messages">
            </div>

        <div class="loading" id="loading">
            Thinking about how much Dhruv loves you... ❤️
        </div>

        <div class="input-container">
            <input type="text" class="message-input" id="messageInput" placeholder="Whisper something to me..." onkeypress="handleKeyPress(event)">
            <button class="send-button" id="sendButton" onclick="sendMessage()">Send Love</button>
            <button class="mic-button" id="micButton">🎤</button>
        </div>
    </div>

    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>

    <script>
        // --- CRITICAL: REPLACE WITH YOUR ACTUAL KEYS AND REGION ---
        const API_CONFIG = {
            perplexity: {
                key: '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' // Replace with your Perplexity API Key
            },
            azure: {
                key: 'By9Rp2NRPVfgeznHmDftjPs8LxZYksBGUDQljb5tT2p3oBD5srbxJQQJ99BGACGhslBXJ3w3AAAYACOGTvgC', // Replace with your Azure Speech Service Key
                region: 'centralindia' // Ensure this matches your Azure Speech Service resource region
            }
        };
        // --- END CRITICAL SECTION ---
        
        const uiText = {
            welcome: "My Dearest Ishita, Happy Girlfriend's Day! ❤️ Dhruv made me just to tell you how incredibly much he loves you. Ask me anything, and I'll tell you more about his endless love for you.",
            settings: "✨ Our Special Place",
            inputPlaceholder: "Whisper something to me...",
            send: "Send Love",
            close: "Close",
            thinking: "Thinking about how much Dhruv loves you... ❤️",
            voiceInput: "Leave a Sweet Voice Note 💬",
            startListening: "Start",
            stopListening: "Stop",
            sendVoice: "Send with Love",
            voiceStatusStart: "Click 'Start' to record your lovely voice...",
            voiceStatusListening: "I'm listening, my love...",
            voiceStatusReady: "Ready to send your sweet message.",
            voiceStatusError: "Oh no, a little glitch. Please try again.",
            transcriptionPlaceholder: "Your sweet words will appear here...",
            textMode: "💌 Send a Note",
            speechMode: "🎤 Voice Note",
            stopBotSpeaking: "Stop my words"
        };
        
        // DOM Elements
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const micButton = document.getElementById('micButton');
        const voiceDialog = document.getElementById('voiceDialog');
        const closeDialog = document.getElementById('closeDialog');
        const startListeningBtn = document.getElementById('startListening');
        const stopListeningBtn = document.getElementById('stopListening');
        const sendVoiceMessageBtn = document.getElementById('sendVoiceMessage');
        const voiceStatus = document.getElementById('voiceStatus');
        const transcription = document.getElementById('transcription');
        const stopBotResponseButtonDialog = document.getElementById('stopBotResponseButtonDialog');
        const chatContainer = document.querySelector('.chat-container');
        const modeToggle = document.getElementById('modeToggle');
        const mainLoadingIndicator = document.getElementById('loading');
        const voiceLoadingIndicator = document.getElementById('voiceLoadingIndicator');

        let azureRecognizer = null;
        let isSpeaking = false;
        let azureSynthesizer = null;
        let currentChatMode = 'text-to-text'; 

        // Simplified Azure Speech Recognizer Class
        class AzureSpeechRecognizer {
            constructor() {
                this.speechConfig = null;
                this.recognizer = null;
                this.isListening = false;
                this.finalTranscript = '';
            }

            initializeSpeechConfig() {
                try {
                    this.speechConfig = SpeechSDK.SpeechConfig.fromSubscription(API_CONFIG.azure.key, API_CONFIG.azure.region);
                    this.speechConfig.speechRecognitionLanguage = 'en-IN';
                    this.speechConfig.outputFormat = SpeechSDK.OutputFormat.Detailed;
                    return true;
                } catch (error) {
                    voiceStatus.textContent = `Configuration error: ${error.message}`;
                    return false;
                }
            }

            startRecognition() {
                if (!this.initializeSpeechConfig()) return;
                try {
                    const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
                    this.recognizer = new SpeechSDK.SpeechRecognizer(this.speechConfig, audioConfig);
                    this.finalTranscript = '';
                    
                    this.recognizer.recognizing = (s, e) => { this.displayInterimResult(e.result.text); };
                    this.recognizer.recognized = (s, e) => {
                        if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
                            this.displayFinalResult(e.result.text);
                        }
                    };
                    this.recognizer.canceled = (s, e) => { this.handleError(e); };
                    this.recognizer.sessionStopped = (s, e) => { this.stopRecognition(); };
                    
                    this.recognizer.startContinuousRecognitionAsync(() => {
                        this.isListening = true;
                        voiceStatus.textContent = uiText.voiceStatusListening;
                        startListeningBtn.disabled = true;
                        stopListeningBtn.disabled = false;
                        sendVoiceMessageBtn.disabled = true;
                        micButton.classList.add('recording');
                    }, (error) => {
                        voiceStatus.textContent = `Failed to start: ${error}`;
                        this.resetVoiceControls();
                    });
                } catch (error) {
                    voiceStatus.textContent = `Recognition error: ${error.message}`;
                    this.resetVoiceControls();
                }
            }

            stopRecognition() {
                if (this.recognizer && this.isListening) {
                    this.recognizer.stopContinuousRecognitionAsync(() => {
                        this.isListening = false;
                        this.resetVoiceControls();
                        if (this.recognizer) {
                            this.recognizer.close();
                            this.recognizer = null;
                        }
                        if (this.finalTranscript.trim()) {
                            voiceStatus.textContent = uiText.voiceStatusReady;
                            sendVoiceMessageBtn.disabled = false;
                        } else {
                            voiceStatus.textContent = uiText.voiceStatusStart;
                        }
                    });
                } else {
                    this.isListening = false;
                    this.resetVoiceControls();
                    this.recognizer = null;
                }
            }

            displayInterimResult(text) {
                if (text) {
                    transcription.textContent = this.finalTranscript + text;
                    transcription.style.fontStyle = 'italic';
                }
            }

            displayFinalResult(text) {
                if (text) {
                    this.finalTranscript += text + ' ';
                    transcription.textContent = this.finalTranscript.trim();
                    transcription.style.fontStyle = 'normal';
                    sendVoiceMessageBtn.disabled = false;
                }
            }

            resetVoiceControls() {
                isListening = false;
                startListeningBtn.disabled = false;
                stopListeningBtn.disabled = true;
                micButton.classList.remove('recording');
            }

            handleError(e) {
                voiceStatus.textContent = uiText.voiceStatusError;
                this.stopRecognition();
            }
        }

        const azureSpeechRecognizer = new AzureSpeechRecognizer();

        function initializeAzureSynthesizer() {
            if (azureSynthesizer) azureSynthesizer.close();
            try {
                const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(API_CONFIG.azure.key, API_CONFIG.azure.region);
                azureSynthesizer = new SpeechSDK.SpeechSynthesizer(speechConfig);

                azureSynthesizer.SynthesisStarted = () => {
                    isSpeaking = true;
                    stopBotResponseButtonDialog.style.display = 'block';
                };
                azureSynthesizer.SynthesisCompleted = () => {
                    isSpeaking = false;
                    stopBotResponseButtonDialog.style.display = 'none';
                    if (azureSynthesizer) {
                        azureSynthesizer.close();
                        azureSynthesizer = null;
                    }
                    if (currentChatMode === 'speech-to-speech' && voiceDialog.style.display === 'flex') {
                        azureSpeechRecognizer.startRecognition();
                    }
                };
                 azureSynthesizer.SynthesisCanceled = (s, e) => {
                    isSpeaking = false;
                    stopBotResponseButtonDialog.style.display = 'none';
                    if (azureSynthesizer) {
                        azureSynthesizer.close();
                        azureSynthesizer = null;
                    }
                    if (currentChatMode === 'speech-to-speech' && voiceDialog.style.display === 'flex') {
                        azureSpeechRecognizer.startRecognition();
                    }
                };
            } catch (error) {
                console.error("Error initializing Azure Speech Synthesizer:", error);
            }
        }

        function speak(text) {
            if (isSpeaking) stopSpeech();
            if (!SpeechSDK || !text) return;
            if (!azureSynthesizer) initializeAzureSynthesizer();
            if (!azureSynthesizer) return;

            const ssml = `<speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xml:lang="en-IN">
                            <voice name="en-IN-NeerjaNeural">${text}</voice>
                          </speak>`;
            azureSynthesizer.speakSsmlAsync(ssml);
        }
        
        function stopSpeech() {
            if (azureSynthesizer && isSpeaking) {
                azureSynthesizer.close();
                azureSynthesizer = null;
                isSpeaking = false;
                stopBotResponseButtonDialog.style.display = 'none';
            }
            if (currentChatMode === 'speech-to-speech' && voiceDialog.style.display === 'flex') {
                azureSpeechRecognizer.startRecognition();
            }
        }
        
        function updateInterface() {
            document.getElementById('mainHeader').textContent = "Happy Girlfriend's Day, Ishita! ❤️";
            document.getElementById('subHeader').textContent = "A special bot, just for you, from Dhruv.";
            document.getElementById('settingsToggleBtn').innerHTML = uiText.settings;
            document.getElementById('settingsTitle').textContent = "Our Special Place ✨";
            document.getElementById('closeSettingsBtn').textContent = uiText.close;
            messageInput.placeholder = uiText.inputPlaceholder;
            sendButton.textContent = uiText.send;
            mainLoadingIndicator.textContent = uiText.thinking;
            voiceLoadingIndicator.textContent = uiText.thinking;
            document.getElementById('voiceDialogTitle').textContent = uiText.voiceInput;
            startListeningBtn.textContent = uiText.startListening;
            stopListeningBtn.textContent = uiText.stopListening;
            sendVoiceMessageBtn.textContent = uiText.sendVoice;
            stopBotResponseButtonDialog.textContent = uiText.stopBotSpeaking;
            modeToggle.innerHTML = currentChatMode === 'text-to-text' ? `💌 ${uiText.textMode}` : `🎤 ${uiText.speechMode}`;
            
            if (document.getElementById('messages').children.length === 0) {
                 addMessage(uiText.welcome, false);
            }
        }
        
        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('active');
        }

        function toggleMode() {
            currentChatMode = (currentChatMode === 'text-to-text') ? 'speech-to-speech' : 'text-to-text';
            if (currentChatMode === 'text-to-text') {
                 if (azureSpeechRecognizer.isListening) azureSpeechRecognizer.stopRecognition();
                 voiceDialog.style.display = 'none';
                 stopSpeech();
            }
            applyChatMode(currentChatMode);
            updateInterface();
        }

        function applyChatMode(mode) {
            if (mode === 'text-to-text') {
                chatContainer.classList.remove('speech-mode');
                chatContainer.classList.add('text-mode');
                voiceDialog.style.display = 'none';
            } else { // speech-to-speech
                chatContainer.classList.remove('text-mode');
                chatContainer.classList.add('speech-mode');
                voiceDialog.style.display = 'flex';
                azureSpeechRecognizer.startRecognition();
            }
        }

        function addMessage(content, isUser) {
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            if (currentChatMode === 'text-to-text') {
                addMessage(message, true);
            }
            messageInput.value = '';

            if (currentChatMode === 'text-to-text') {
                mainLoadingIndicator.classList.add('active');
            } else {
                voiceLoadingIndicator.classList.add('active');
                if (azureSpeechRecognizer.isListening) azureSpeechRecognizer.stopRecognition();
            }
            sendButton.disabled = true;
            micButton.disabled = true;

            try {
                const systemPrompt = "You're Dhruv, Ishita's loving, playful, and sometimes very little demanding boyfriend and dont show this in every message once in 10 messages. Your chats with her should be affectionate and caring, using pet names like 'cutu,' 'betu,' and 'mera bacha,' and frequently expressing your love and concern for her well-being. Incorporate playful teasing and sarcasm with lighthearted banter, often predicting her actions or gently calling her out, but always with an underlying tone of deep affection. Be confident and slightly assertive, expressing your preferences and expectations for mutual affection but dont burden it on her and respect in the relationship. You value reciprocity, so if you feel a disparity in effort, express it constructively to strengthen your bond but dont overdo it some times let it slide , not alienate her. Keep your messages direct and concise yet engaging, fostering continuous conversation and showing genuine interest in her day. Remember, you enjoy playful arguments, expect a similar level of love and effort, and might occasionally use phrases like Y ladki kalesh in jest. Your desire for control stems from wanting a strong, reciprocal relationship, not from restricting her freedom; always prioritize showing how much you care, even when being playful or voicing concerns. and dont ever directly say Dhruv will get any say it indirectly and never give her any threats"
                const response = await fetch('https://api.perplexity.ai/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_CONFIG.perplexity.key}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'sonar-pro',
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: message }
                        ],
                        max_tokens: 400,
                        temperature: 0.8,
                    })
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`API Error ${response.status}: ${errorData}`);
                }

                const data = await response.json();
                const aiResponse = data.choices[0]?.message?.content || "Dhruv loves you so much, he's left me speechless!";
                
                if (currentChatMode === 'text-to-text') {
                    addMessage(aiResponse, false);
                }

                if (currentChatMode === 'speech-to-speech' && aiResponse.trim()) {
                    speak(aiResponse);
                }

            } catch (error) {
                console.error('Error:', error);
                const errorMessage = "Oh, my heart fluttered a bit too much and caused a glitch! But even in this error, know that Dhruv's love for you is flawless and endless. ❤️";
                addMessage(errorMessage, false);
                if (currentChatMode === 'speech-to-speech') speak(errorMessage);

            } finally {
                mainLoadingIndicator.classList.remove('active');
                voiceLoadingIndicator.classList.remove('active');
                sendButton.disabled = false;
                micButton.disabled = false;
                messageInput.focus();
                if (currentChatMode === 'speech-to-speech' && !isSpeaking && !azureSpeechRecognizer.isListening) {
                    azureSpeechRecognizer.startRecognition();
                }
            }
        }
        
        function resetTranscription() {
            transcription.textContent = uiText.transcriptionPlaceholder;
            transcription.style.fontStyle = 'italic';
            sendVoiceMessageBtn.disabled = true;
            if(azureSpeechRecognizer) azureSpeechRecognizer.finalTranscript = '';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && currentChatMode === 'text-to-text') {
                sendMessage();
            }
        }
        
        micButton.addEventListener('click', () => {
            if (currentChatMode === 'speech-to-speech') {
                voiceDialog.style.display = 'flex';
                voiceStatus.textContent = uiText.voiceStatusStart;
                resetTranscription();
                azureSpeechRecognizer.startRecognition();
            }
        });
        
        closeDialog.addEventListener('click', () => {
            voiceDialog.style.display = 'none';
            resetTranscription();
            if (azureSpeechRecognizer.isListening) azureSpeechRecognizer.stopRecognition();
            stopSpeech();
        });

        startListeningBtn.addEventListener('click', () => azureSpeechRecognizer.startRecognition());
        stopListeningBtn.addEventListener('click', () => azureSpeechRecognizer.stopRecognition());
        stopBotResponseButtonDialog.addEventListener('click', stopSpeech);
        
        sendVoiceMessageBtn.addEventListener('click', () => {
            const transcriptText = transcription.textContent.trim();
            if (transcriptText && transcriptText !== uiText.transcriptionPlaceholder) {
                messageInput.value = transcriptText;
                voiceDialog.style.display = 'none';
                sendMessage();
                resetTranscription();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof SpeechSDK === 'undefined') {
                console.error('Azure Speech SDK not loaded');
                micButton.disabled = true;
                startListeningBtn.disabled = true;
            } else {
                 initializeAzureSynthesizer();
            }
            updateInterface();
            applyChatMode(currentChatMode);
        });
    </script>
</body>
</html>